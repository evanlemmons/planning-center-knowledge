name: Knowledge Base Health Check

on:
  schedule:
    - cron: '0 14 * * 1'  # Every Monday at 10am ET (14:00 UTC)
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for oversized knowledge files
        id: oversized
        run: |
          oversized=""
          # Check curated files (skip raw/ directory which can be longer)
          for f in $(find . -name "*.md" -not -path "./raw/*" -not -path "./.github/*" -not -name "README.md"); do
            lines=$(wc -l < "$f")
            if [ "$lines" -gt 200 ]; then
              echo "::warning::$f is $lines lines (should be under 200)"
              oversized="$oversized\n- $f ($lines lines)"
            fi
          done

          if [ -n "$oversized" ]; then
            echo "oversized=true" >> $GITHUB_OUTPUT
            echo -e "Oversized files:$oversized"
          else
            echo "oversized=false" >> $GITHUB_OUTPUT
            echo "All knowledge files are within size limits."
          fi

      - name: Verify product file coverage
        id: coverage
        run: |
          missing=""
          # Products referenced in overview.md that should have files
          for product in accounts calendar check-ins church-center giving groups home music-stand people publishing registrations services; do
            if [ ! -f "products/$product.md" ]; then
              echo "::error::Missing product file: products/$product.md"
              missing="$missing\n- products/$product.md"
            fi
          done

          if [ -n "$missing" ]; then
            echo "missing=true" >> $GITHUB_OUTPUT
          else
            echo "missing=false" >> $GITHUB_OUTPUT
            echo "All expected product files present."
          fi

      - name: Create issue if problems found
        if: steps.oversized.outputs.oversized == 'true' || steps.coverage.outputs.missing == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = [];
            if ('${{ steps.oversized.outputs.oversized }}' === 'true') {
              issues.push('- Knowledge files exceeding 200-line limit (see workflow log)');
            }
            if ('${{ steps.coverage.outputs.missing }}' === 'true') {
              issues.push('- Missing expected product files (see workflow log)');
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `KB Health Check: ${issues.length} issue(s) found`,
              body: `## Knowledge Base Health Check\n\n${issues.join('\n')}\n\nCheck the [action log](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions) for details.`,
              labels: ['maintenance']
            });
